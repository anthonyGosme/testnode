<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Espace Upload - <%= tenant.name %></title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <link rel='stylesheet' href='https://cdn.form.io/formiojs/formio.full.min.css'>
    
    <script src='https://cdn.form.io/formiojs/formio.full.min.js'></script>

    <style>
        /* Injection de la couleur du th√®me depuis le YAML */
        :root {
            --primary-color: <%= tenant.theme.primaryColor %>;
        }

        body {
            background-color: #f3f4f6;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
        }

        .card {
            background: white;
            border: none;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            width: 90%;
            max-width: 600px;
            overflow: hidden;
            border-radius: 12px;
        }

        .card-header {
            background-color: var(--primary-color);
            color: white;
            padding: 1.5rem;
            text-align: center;
            border-bottom: none;
        }

        .card-header h3 {
            margin: 0;
            font-weight: 600;
        }

        .card-body {
            padding: 2rem;
        }

        /* Petits ajustements pour que le composant File de Form.io soit joli */
        .formio-component-file {
            background: #f8fafc;
            padding: 15px;
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .btn-primary {
            background-color: var(--primary-color) !important;
            border-color: var(--primary-color) !important;
        }
    </style>
</head>
<body>

<div class="card">
    <div class="card-header">
        <h3><%= tenant.name %></h3>
        <small>Portail S√©curis√© de D√©p√¥t</small>
    </div>
    <div class="card-body">
        <div id="formio"></div>
    </div>
</div>

<script>

    const formSchema = <%- JSON.stringify(formSchema) %>;

    Formio.createForm(document.getElementById('formio'), formSchema)
    .then(function(form) {
        console.log("‚úÖ Formulaire charg√© avec succ√®s.");

        // Feedback quand le formulaire global est soumis
        form.on('submitDone', function(submission) {
             alert('Document transmis avec succ√®s !');
        });
    });
</script>
<% if (tenant.paths && tenant.paths.preflight) { %>
    <script src="<%= urlBase %>/preflight.js"></script>
<% } %>

<script>
(function() {
    // --- 1. CONFIGURATION INTERCEPTEUR (Reste actif pour l'upload) ---
    // On le d√©clare tout de suite pour qu'il soit pr√™t
    window.PREFLIGHT_CACHE = {}; 
    const metaKeyConfig = "<%= tenant.metaKey || 'refFacture' %>";
    
    const originalOpen = XMLHttpRequest.prototype.open;
    const originalSend = XMLHttpRequest.prototype.send;

    XMLHttpRequest.prototype.open = function(method, url) {
        this._debugUrl = url; 
        return originalOpen.apply(this, arguments);
    };

    XMLHttpRequest.prototype.send = function(body) {
        if (this._debugUrl && this._debugUrl.includes('upload')) {
            // ... (Votre logique d'injection de headers existante) ...
            // Elle utilisera window.PREFLIGHT_CACHE qui sera rempli juste apr√®s
            if (window.PREFLIGHT_CACHE) {
                 Object.keys(window.PREFLIGHT_CACHE).forEach(key => {
                    let headerKey = key.toLowerCase();
                    if (!headerKey.startsWith('x-meta-')) headerKey = `x-meta-ctx-${headerKey}`; 
                    this.setRequestHeader(headerKey, encodeURIComponent(window.PREFLIGHT_CACHE[key]));
                });
            }
            // Injection de la valeur du champ principal (metaKey)
            const inputName = `data[${metaKeyConfig}]`;
            const inputElement = document.querySelector(`input[name="${inputName}"]`);
            if (inputElement && inputElement.value) {
                 this.setRequestHeader(`x-meta-${metaKeyConfig.toLowerCase()}`, encodeURIComponent(inputElement.value));
            }
        }
        return originalSend.apply(this, arguments);
    };


    // --- 2. ORCHESTRATION : PREFLIGHT PUIS FORMULAIRE ---
    const formSchema = <%- JSON.stringify(formSchema) %>;

    async function initPage() {
        let contextData = {};

        // A. On ex√©cute le Preflight (s'il existe)
        if (typeof window.runPreflight === 'function') {
            try {
                console.log("üïµÔ∏è R√©cup√©ration du contexte...");
                contextData = await window.runPreflight();
                
                // 1. On met √† jour le cache pour les headers (Backend)
                window.PREFLIGHT_CACHE = contextData || {};
                
                console.log("‚úÖ Contexte charg√© :", contextData);
            } catch (err) {
                console.error("‚ùå Erreur Preflight:", err);
            }
        }

        // B. On initialise le formulaire AVEC les donn√©es (Frontend)
        Formio.createForm(document.getElementById('formio'), formSchema)
            .then(function(form) {
                
                // C'EST ICI QUE √áA SE PASSE : Pr√©-remplissage
                if (contextData && Object.keys(contextData).length > 0) {
                    // On injecte les donn√©es du preflight directement dans le formulaire
                    form.submission = {
                        data: { 
                            ...form.submission.data, // Garde les d√©fauts √©ventuels
                            ...contextData           // √âcrase avec les donn√©es de l'URL
                        }
                    };
                    console.log("üìù Champs du formulaire remplis automatiquement.");
                }

                form.on('submitDone', function(submission) {
                     alert('Document transmis avec succ√®s !');
                });
            });
    }

    // Lancement de la page
    initPage();

})();
</script>
</body>
