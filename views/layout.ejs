<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Espace D√©p√¥t - <%= tenant.name %></title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel='stylesheet' href='https://cdn.form.io/formiojs/formio.full.min.css'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src='https://cdn.form.io/formiojs/formio.full.min.js'></script>

    <style>
        /* Injection du th√®me client */
        :root { --primary-color: <%= tenant.theme.primaryColor %>; }
        
        body { 
            background-color: #f3f4f6; 
            min-height: 100vh; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-family: 'Segoe UI', sans-serif; 
            margin: 0;
        }
        
        .card { 
            border: none; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.05); 
            width: 90%; 
            max-width: 600px; 
            border-radius: 12px; 
            overflow: hidden; 
            background: white; 
        }
        
        .card-header { 
            background-color: var(--primary-color); 
            color: white; 
            padding: 1.5rem; 
            text-align: center; 
        }
        
        .card-body { padding: 2rem; }
        
        .formio-component-file { 
            background: #f8fafc; 
            padding: 15px; 
            border: 2px dashed #cbd5e1; 
            border-radius: 8px; 
            margin-top: 20px; 
        }
        
        .btn-primary { 
            background-color: var(--primary-color) !important; 
            border-color: var(--primary-color) !important; 
        }
    </style>
</head>
<body>

<div class="card">
<div class="card-header">
        <% if (tenant.theme && tenant.theme.logo) { %>
            <div class="mb-3">
                <img src="<%= urlBase %>/logo.png" alt="Logo" style="max-height: 60px; max-width: 100%;">
            </div>
        <% } %>
        
        <h3 class="m-0"><%= tenant.name %></h3>
        <small class="opacity-75">Portail S√©curis√©</small>
    </div>
    <div class="card-body">
        <div id="formio"></div>
    </div>
</div>

<% if (tenant.paths && tenant.paths.preflight) { %>
    <script src="<%= urlBase %>/preflight.js"></script>
<% } %>

<script>
(function() {
    // --- 1. CONFIGURATION DE L'INTERCEPTEUR (C≈ìur du syst√®me) ---
    // Cet intercepteur agit au moment o√π le fichier est envoy√© par Form.io
    
    window.PREFLIGHT_CACHE = {}; 
    const originalOpen = XMLHttpRequest.prototype.open;
    const originalSend = XMLHttpRequest.prototype.send;

    XMLHttpRequest.prototype.open = function(method, url) {
        this._debugUrl = url; 
        return originalOpen.apply(this, arguments);
    };

    XMLHttpRequest.prototype.send = function(body) {
        // On ne cible que les requ√™tes d'upload de fichiers
        if (this._debugUrl && this._debugUrl.includes('upload')) {
            console.log("üì§ Interception de l'upload vers : " + this._debugUrl);

            // A. Injection des donn√©es du Preflight (Login, Contexte URL...)
            if (window.PREFLIGHT_CACHE) {
                 Object.keys(window.PREFLIGHT_CACHE).forEach(key => {
                    let h = key.toLowerCase();
                    // On pr√©fixe par s√©curit√© 'ctx' pour les donn√©es syst√®me
                    if (!h.startsWith('x-meta-')) h = `x-meta-ctx-${h}`; 
                    this.setRequestHeader(h, encodeURIComponent(window.PREFLIGHT_CACHE[key]));
                });
            }

            // B. Injection AUTOMATIQUE de tous les champs du formulaire (Correctif Universel)
            // On cherche : Inputs, Selects (listes), Textareas qui ont un nom type "data[...]"
            const formElements = document.querySelectorAll('input[name^="data["], select[name^="data["], textarea[name^="data["]');
            
            formElements.forEach(el => {
                // 1. On extrait le nom de la variable (ex: "refDossier" depuis "data[refDossier]")
                const match = el.name.match(/data\[(.*?)\]/);
                
                // Si pas de match ou si c'est le champ fichier lui-m√™me, on ignore
                if (!match || !match[1] || el.type === 'file') return;

                // Cas particulier : Radio/Checkbox (on ne prend que ce qui est coch√©)
                if ((el.type === 'radio' || el.type === 'checkbox') && !el.checked) return;

                const key = match[1].toLowerCase(); // ex: refdossier
                const headerName = `x-meta-${key}`; // ex: x-meta-refdossier
                const value = el.value;

                // 2. Si une valeur existe, on l'ajoute en header
                if (value && value.trim() !== "") {
                    // Note: encodeURIComponent est vital pour les accents et caract√®res sp√©ciaux
                    this.setRequestHeader(headerName, encodeURIComponent(value));
                    console.log(`   ‚ûï M√©tadonn√©e ajout√©e : ${headerName} = ${value}`);
                }
            });
        }
        return originalSend.apply(this, arguments);
    };

    // --- 2. INITIALISATION DE LA PAGE ---
    const formSchema = <%- JSON.stringify(formSchema) %>;

    async function initPage() {
        let contextData = {};
        
        // Etape A : Ex√©cution du script Preflight (si pr√©sent)
        if (typeof window.runPreflight === 'function') {
            try {
                console.log("üïµÔ∏è Ex√©cution du Preflight...");
                contextData = await window.runPreflight();
                
                // On stocke le r√©sultat pour l'intercepteur ci-dessus
                window.PREFLIGHT_CACHE = contextData || {};
                console.log("‚úÖ Contexte charg√© :", contextData);
            } catch (err) {
                console.error("‚ùå Erreur Preflight:", err);
            }
        }

        // Etape B : Affichage du formulaire
        Formio.createForm(document.getElementById('formio'), formSchema)
        .then(function(form) {
            
            // Pr√©-remplissage des champs visuels avec les donn√©es du contexte
            if (Object.keys(contextData).length > 0) {
                form.submission = {
                    data: { ...form.submission.data, ...contextData }
                };
                console.log("üìù Formulaire pr√©-rempli.");
            }

            // Feedback simple lors de la validation finale
            // (Note: Dans votre mode actuel, le fichier est d√©j√† parti √† ce moment l√†)
            form.on('submitDone', function(submission) {
                 alert('Dossier trait√© avec succ√®s !');
            });
        });
    }

    // Lancement
    initPage();

})();
</script>
</body>
</html>