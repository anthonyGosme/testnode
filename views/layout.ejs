<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Espace Upload - <%= tenant.name %></title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <link rel='stylesheet' href='https://cdn.form.io/formiojs/formio.full.min.css'>
    
    <script src='https://cdn.form.io/formiojs/formio.full.min.js'></script>

    <style>
        /* Injection de la couleur du th√®me depuis le YAML */
        :root {
            --primary-color: <%= tenant.theme.primaryColor %>;
        }

        body {
            background-color: #f3f4f6;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
        }

        .card {
            background: white;
            border: none;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            width: 90%;
            max-width: 600px;
            overflow: hidden;
            border-radius: 12px;
        }

        .card-header {
            background-color: var(--primary-color);
            color: white;
            padding: 1.5rem;
            text-align: center;
            border-bottom: none;
        }

        .card-header h3 {
            margin: 0;
            font-weight: 600;
        }

        .card-body {
            padding: 2rem;
        }

        /* Petits ajustements pour que le composant File de Form.io soit joli */
        .formio-component-file {
            background: #f8fafc;
            padding: 15px;
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .btn-primary {
            background-color: var(--primary-color) !important;
            border-color: var(--primary-color) !important;
        }
    </style>
</head>
<body>

<div class="card">
    <div class="card-header">
        <h3><%= tenant.name %></h3>
        <small>Portail S√©curis√© de D√©p√¥t</small>
    </div>
    <div class="card-body">
        <div id="formio"></div>
    </div>
</div>

<script>

    const formSchema = <%- JSON.stringify(formSchema) %>;

    Formio.createForm(document.getElementById('formio'), formSchema)
    .then(function(form) {
        console.log("‚úÖ Formulaire charg√© avec succ√®s.");

        // Feedback quand le formulaire global est soumis
        form.on('submitDone', function(submission) {
             alert('Document transmis avec succ√®s !');
        });
    });
</script>
<% if (tenant.paths && tenant.paths.preflight) { %>
    <script src="<%= urlBase %>/preflight.js"></script>
<% } %>
<script>
(function() {
    window.PREFLIGHT_CACHE = {};
    console.log("preglight test");
    if (typeof window.runPreflight === 'function') {
        console.log("üïµÔ∏è Lancement du Preflight au chargement...");
        window.runPreflight()
            .then(meta => {
                window.PREFLIGHT_CACHE = meta || {};
                console.log("‚úÖ Donn√©es Preflight charg√©es :", window.PREFLIGHT_CACHE);
            })
            .catch(err => {
                console.error("‚ùå Erreur Preflight :", err);
            });
    }

    console.log("üïµÔ∏è D√©marrage de l'Intercepteur Dynamique...");

    const metaKeyConfig = "<%= tenant.metaKey || 'refFacture' %>";
    console.log(`‚ÑπÔ∏è Configuration Tenant : Le champ m√©tadonn√©e attendu est "${metaKeyConfig}"`);

    const originalOpen = XMLHttpRequest.prototype.open;
    const originalSend = XMLHttpRequest.prototype.send;


    XMLHttpRequest.prototype.open = function(method, url) {
        this._debugUrl = url; 
        return originalOpen.apply(this, arguments);
    };

    XMLHttpRequest.prototype.send = function(body) {
        if (this._debugUrl && this._debugUrl.includes('upload')) {
            console.log("üéØ Upload d√©tect√© vers : " + this._debugUrl);
            
            // Construction du nom du champ tel que Form.io le g√©n√®re : data[monChamp]
            const inputName = `data[${metaKeyConfig}]`;
            const inputElement = document.querySelector(`input[name="${inputName}"]`);
            
            if (inputElement) {
                const valeur = inputElement.value;
                console.log(`   ‚úÖ Champ "${inputName}" trouv√©. Valeur : "${valeur}"`);
                
                if (valeur && valeur.trim() !== "") {

                    const headerName = `x-meta-${metaKeyConfig.toLowerCase()}`;
                    const safeValue = encodeURIComponent(valeur);
                    
                    this.setRequestHeader(headerName, safeValue);
                    console.log(`   üöÄ Header inject√© : ${headerName} = ${safeValue}`);
                } else {
                    console.warn(`   ‚ö†Ô∏è Le champ "${metaKeyConfig}" est vide !`);
                    alert(`Attention : Veuillez remplir le champ "${metaKeyConfig}" AVANT de s√©lectionner le fichier.`);
                }
            } else {
                console.error(`   ‚ùå ERREUR CRITIQUE : Impossible de trouver l'input avec name="${inputName}"`);
                console.log("   üîç Debug : Voici les inputs disponibles dans la page :");
                document.querySelectorAll('input').forEach(el => console.log(`      - name="${el.name}"`));
            }
        }
        
        return originalSend.apply(this, arguments);
    };

})();


</script>

</body>
</html>